---
import "@/styles/global.css";
import Header from "@/components/Header/Header.astro";
import Footer from "@/components/Footer/Footer.astro";
import { urlFromBase } from "@lib/utils";

import { frontmatter as Selfie } from "#/selfie.md";

const { pageTitle } = Astro.props;
const base = import.meta.env.BASE_URL;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href={Selfie.favicon} />
    <link
      rel="preload"
      href={urlFromBase(base, "/fonts/HackDejavu.woff2")}
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href={urlFromBase(base, "/fonts/HackDejavuBold.woff2")}
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href={urlFromBase(base, "/fonts/HackDejavuItalic.woff2")}
      as="font"
      type="font/woff2"
      crossorigin
    />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>{pageTitle}</title>
    <script is:inline>
      function init() {
        preloadTheme();

        const lightThemeButton = document.getElementById("light-theme-button");
        lightThemeButton?.addEventListener("click", () => {
          localStorage.setItem("theme", "light");
          toggleTheme(false);
        });

        const darkThemeButton = document.getElementById("dark-theme-button");
        darkThemeButton?.addEventListener("click", () => {
          localStorage.setItem("theme", "dark");
          toggleTheme(true);
        });

        const systemThemeButton = document.getElementById(
          "system-theme-button",
        );

        systemThemeButton?.addEventListener("click", () => {
          localStorage.setItem("theme", "system");
          toggleTheme(
            window.matchMedia("(prefers-color-scheme: dark)").matches,
          );
        });

        window
          .matchMedia("(prefers-color-scheme: dark)")
          .addEventListener("change", (event) => {
            if (localStorage.theme === "system") {
              toggleTheme(event.matches);
            }
          });
      }

      function toggleTheme(dark) {
        const css = document.createElement("style");

        css.appendChild(
          document.createTextNode(
            `* {
             -webkit-transition: none !important;
             -moz-transition: none !important;
             -o-transition: none !important;
             -ms-transition: none !important;
             transition: none !important;
          }
        `,
          ),
        );

        document.head.appendChild(css);

        if (dark) {
          document.documentElement.classList.add("dark");
        } else {
          document.documentElement.classList.remove("dark");
        }

        window.getComputedStyle(css).opacity;
        document.head.removeChild(css);
      }

      function preloadTheme() {
        const userTheme = localStorage.theme;

        if (userTheme === "light" || userTheme === "dark") {
          toggleTheme(userTheme === "dark");
        } else {
          toggleTheme(
            window.matchMedia("(prefers-color-scheme: dark)").matches,
          );
        }
      }

      document.addEventListener("DOMContentLoaded", () => init());
      document.addEventListener("astro:after-swap", () => init());
      preloadTheme();
    </script>
  </head>
  <body>
    <div class="flex flex-col mx-auto px-8 max-w-screen-md w-full min-h-screen">
      <Header />
      <div class="grow mt-32">
        <slot />
      </div>
      <Footer />
    </div>
  </body>
</html>
